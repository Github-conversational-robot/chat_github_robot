### Why JWT tokenï¼Ÿ

é¡¹ç›®é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œç›¸æ¯”äºsession, JWT tokenä¼šæ›´åŠ çš„åˆé€‚ã€‚



### è®¤è¯

é¦–å…ˆå¯¹ç™»å½•/æ³¨å†Œ/å‘é€éªŒè¯ç è¿›è¡Œæ”¾è¡Œã€‚éœ€è¦åœ¨`WebSecurityConfig` ä¸­è¿›è¡Œé…ç½®

```java
protected void configure(HttpSecurity httpSecurity) throws Exception {
  XXX
  XXX  
	//å…è®¸åŒ¿ååŠç™»å½•ç”¨æˆ·è®¿é—®
 	.antMatchers("/api/auth/**", "/api/guest/**", "/error/**").permitAll()
	// å…¶ä»–è¯·æ±‚éƒ½éœ€è¦è®¤è¯
	.anyRequest().authenticated()
	.and().apply(securityConfigurerAdapter());
}
```



#### ç™»å½•æµç¨‹

<img src="/Users/cengqingning/Library/Application Support/typora-user-images/image-20240218201539273.png" alt="image-20240218201539273" style="zoom:50%;" />

**Step1** å‰åç«¯ä¿¡æ¯ä¼ è¾“

RSAåŠ å¯†ç®—æ³•

å‰ç«¯RSAåŠ å¯†ï¼Œåç«¯RSAè§£å¯†ï¼ˆå¯†é’¥ï¼‰ã€‚

**Step2**  springSecurity è®¤è¯ï¼Œç”ŸæˆAuthentication

å°†ç”¨æˆ·å/å¯†ç å°è£…ğŸ“¦æˆAuthentication token å¹¶è°ƒç”¨authenticationManagerçš„authenticationè¿›è¡Œè®¤è¯ã€‚

<img src="/Users/cengqingning/Library/Application Support/typora-user-images/image-20240218203042386.png" alt="image-20240218203042386" style="zoom:67%;" />

å¦‚æœè®¤è¯é€šè¿‡ï¼Œè¿”å›ä¸€ä¸ªauthenticationã€‚(è¿™é‡Œä¼šæ¶‰åŠåˆ°ç¬¬äºŒæ¬¡è§£å¯†)

**Step3** å­˜å…¥ SecurityContextHolder

**Step4**  ç”Ÿæˆtoken

åˆ©ç”¨è¯¥authenticationåˆ›å»ºä¸€ä¸ªJWT tokenã€‚

```java
 JwtUserDto jwtUserDto = (JwtUserDto) authentication.getPrincipal();
```

- `authentication.getPrincipal()` è¿”å› `Authentication` å¯¹è±¡ä¸­çš„ä¸»ä½“ï¼Œå³è®¤è¯ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ã€‚
- é€šå¸¸æƒ…å†µä¸‹ï¼Œè®¤è¯ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ä¼šè¢«å°è£…åœ¨ä¸€ä¸ªç‰¹å®šçš„å¯¹è±¡ä¸­ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯è®¤è¯è¿‡ç¨‹ä¸­ `UserDetailsService` è¿”å›çš„å¯¹è±¡ï¼Œæˆ–è€…æ˜¯é€šè¿‡è‡ªå®šä¹‰çš„ `AuthenticationProvider` è¿›è¡Œè®¤è¯åè®¾ç½®åˆ° `Authentication` å¯¹è±¡ä¸­çš„å¯¹è±¡ã€‚åœ¨è¿™é‡Œï¼Œè¯¥å¯¹è±¡è¢«è½¬æ¢ä¸º `JwtUserDto` ç±»å‹ï¼Œæ˜¯å› ä¸ºåœ¨è®¤è¯è¿‡ç¨‹ä¸­ä½¿ç”¨äº† JWTï¼ˆJSON Web Tokenï¼‰ä½œä¸ºè®¤è¯æ–¹å¼ï¼Œè€Œ `JwtUserDto` æ˜¯ç”¨æ¥è¡¨ç¤º JWT ä¸­çš„ç”¨æˆ·ä¿¡æ¯çš„æ•°æ®ä¼ è¾“å¯¹è±¡ã€‚

**Step5** å­˜å…¥redisï¼Œå¹¶è¿”å› token å’Œ ç™»å½•ä¿¡æ¯ã€‚
å­˜å…¥redisï¼Œä»è€Œå‡è½»æ•°æ®åº“å‹åŠ›ã€‚
	JWT token   jwtUserDto

**Step6** è¿”å›ç™»å½•ä¿¡æ¯

```json
{
  JwtUser: xxx
  token: xxxx
}
```



#### æ³¨å†Œæµç¨‹

#### æ³¨å†Œ

æ³¨å†Œè¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥ä¸ºå‘é€é‚®ä»¶ï¼Œç¬¬äºŒæ­¥ä¸ºå­˜å‚¨ç”¨æˆ·åå’Œé‚®ç®±ã€‚

##### å‘é€é‚®ä»¶

 :one: <u>æä¾›email service å·¥å…·ç±»</u>

**<font color = green >sendæ–¹æ³• </font>**

å‚æ•°ï¼šé‚®ç®±å®ä½“ç±»

```java
public class EmailDto {
    @NotEmpty
    private List<String> tos;
    @NotBlank
    private String subject;
    @NotBlank
    private String content;
}
```

é…ç½®æ–‡ä»¶ä¸­é…å¥½ç›¸åº”æ–‡ä»¶ä¿¡æ¯ã€‚

è°ƒç”¨hutool packageä¸­çš„Mailç±»å®Œæˆã€‚

å‘é€é€»è¾‘ï¼š

<img src="/Users/cengqingning/Library/Application Support/typora-user-images/image-20240118135852995.png" alt="image-20240118135852995" style="zoom:50%;" />



:two: å®ŒæˆsendMailCodeç›¸åº”æœåŠ¡

**ç¼–å†™æ¥å£**

è¯·æ±‚
Methodï¼š `POST`
URLï¼š `/api/auth/getEmailCode?email=` + email
è¯·æ±‚ä½“ï¼šç©º

>ç”±äºé‚®ç®±ä¸æ˜¯æ•æ„Ÿä¿¡æ¯ï¼Œé€‰æ‹©ç›´æ¥æ”¾åœ¨å‚æ•°ä¸­ä¼ é€’ã€‚

å“åº”ï¼š çŠ¶æ€ç 



##### å­˜å‚¨ç”¨æˆ·ä¿¡æ¯

<u>æ³¨å†Œç™»å½•</u>å®ä½“ç±»

```java
public class AuthUserDto {
    @ApiModelProperty(value = "ç”¨æˆ·å")
    private String userName;
    @ApiModelProperty(value = "å¯†ç ")
    private String password;
    @ApiModelProperty(value = "éªŒè¯ç ")
    private String code;
    @ApiModelProperty(value = "é‚®ç®±")
    private String email ;
}
```

æ¥å£ä¿¡æ¯

URLï¼š/api/auth/register
 method: `post`
è¯·æ±‚ä½“ï¼š
	content-type: json

> å…¶ä¸­ç”¨æˆ·åä¸ºé‚®ç®±å·ï¼Œä¸åœ¨jsonä¸­è¿›è¡Œä¼ é€’ã€‚

å…·ä½“æµç¨‹

<img src="/Users/cengqingning/Library/Application Support/typora-user-images/image-20240118142352130.png" alt="image-20240118142352130" style="zoom:50%;" />



### Tokenè¿‡æ»¤å™¨

```
public class JwtAuthenticationTokenFilter extends OncePerRequestFilter {

    private JwtTokenUtils jwtTokenUtils;

    public JwtAuthenticationTokenFilter(JwtTokenUtils jwtTokenUtils) {
        this.jwtTokenUtils = jwtTokenUtils;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain) throws ServletException, IOException {
        JwtSecurityProperties jwtSecurityProperties = SpringContextHolder.getBean(JwtSecurityProperties.class);
        String requestRri = httpServletRequest.getRequestURI();
        //get request token
        String token = null;
        String bearerToken = httpServletRequest.getHeader(jwtSecurityProperties.getHeader());
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith(jwtSecurityProperties.getTokenStartWith())) {
            token = bearerToken.substring(jwtSecurityProperties.getTokenStartWith().length());
        }
        // check wehtehr token is

        if (StringUtils.hasText(token) && jwtTokenUtils.validateToken(token)) {
            Authentication authentication = jwtTokenUtils.getAuthentication(token);
            if (authentication != null) {
                SecurityContextHolder.getContext().setAuthentication(authentication);
                log.debug("set Authentication to security context for '{}', uri: {}", authentication.getName(), requestRri);
            }
        } else {
            log.debug("no valid JWT token found, uri: {}", requestRri);
        }

        // æ”¾è¡Œ
        filterChain.doFilter(httpServletRequest, httpServletResponse);

    }
}
```

